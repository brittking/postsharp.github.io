---
layout: post 
comments: true
title: "New in PostSharp 4.0: Aspect Repository"
date: 2014-10-14 09:25:29 +02:00
permalink: /post/new-in-postsharp-40-aspect-repository.html
author: "Gael Fraiteur"
---
<p>When we built the undo/redo and threading models features of PostSharp 4.0, we needed had to address the problem of aspect dependencies. Both the Recordable and threading models aspects require the Aggregatable aspect. If the Aggregatable aspect is not present, it should be added automatically.</p>


<h2>Checking whether an aspect has been added to a declaration</h2><p>Adding a dependent aspect automatically is easy: it can be done with the <em>IAspectProvider</em>. What’s more difficult is to know whether an aspect has already been added to a declaration. The aspect can have been added as a custom attribute, as a multicast custom attribute, and in these cases the <em>ReflectionSearch.GetCustomAttributesOnTarget</em> method would do the job. But they also be added dynamically using through <em>IAspectProvider</em>, and up to now there was no API to reflect dynamically added aspects. That’s why we added the <a href="http://doc.postsharp.net/t_postsharp_aspects_iaspectrepositoryservice">IAspectRepositoryService</a> interface. It has two interesting features:</p><ul><li><em>GetAspectInstances</em> and <em>HasAspect</em> methods: Query aspects on a given declaration.</li><li><em>AspectDiscoveryCompleted</em> event: Event raise after all aspects have been discovered and initialized.</li></ul><p>To check whether an aspect has been added to a declaration, the following code is typically used in the implementation of <em>IAspectProvider</em>.</p><pre>PostSharpEnvironment.CurrentProject.GetService&lt;IAspectRepositoryService&gt;.HasAspect( declaration, typeof(Aspect) )</pre>
<h2>Late validations </h2><p>Sometimes it is necessary to programmatically validate code against the presence of aspects. This validation can be done only <em>after</em> all dynamic aspect providers (<em>IAspectProvider</em>) have been executed. For instance, child fields of an immutable class must have be themselves immutable or freezable, which means that, unless this is an intrinsically immutable type like <em>int</em> or <em>string</em>, the aspect must have the Immutable or Freezable aspect. </p><p>This is why we have the <em>AspectDiscoveryCompleted</em> event on the <em>IAspectRepositoryService</em> interface. It allows aspects to execute code at build time after all aspects have been discovered</p><h2>Summary</h2><p>Technically, the new service <em>IAspectRepositoryService</em> allows you to cope with complex dependencies between aspects. But more fundamentally, the feature allows you to create real language extensions composed of several aspects and custom attributes that play well together.</p><p>Happy PostSharping!</p><p>-gael</p>
