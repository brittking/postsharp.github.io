---
layout: post 
comments: true
title: "PostSharp Principles: Day 8 Interception Aspects – Part 2"
date: 2011-07-06 15:16:00 +02:00
permalink: /post/day-8-interception-aspects-e28093-part-2.html
author: "Dustin Davis"
---
<p><a href="http://www.sharpcrafters.com/downloads/blog/2011-06-DustinOnPostSharp-Week1.zip">Download demo project source code</a></p>


  <p>Today we jump face first into the decompiled code of interception aspects. If you have not yet read the previous post (part 1), then I suggest doing so before continuing. We’re going to look at the IoCResolution aspect we built yesterday and finish off with chaining.</p>  <h3>Under the hood</h3>  <p>Using ILSpy, open the PostSharpDemo1.exe and browse to the contactRepository field under ContactManager. </p>  <p><a href="/assets/images/blog/2011-07-06-day_8_interception_aspects_e28093_part_2/image_8.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/images/blog/2011-07-06-day_8_interception_aspects_e28093_part_2/image_thumb_8.png" width="628" height="425"></a></p>  <p>We see a getter and a setter even though this was a field and not a property. The setter contains the standard code to set the backing to the value passed in. There is no change since we did not implement OnSetValue in our aspect. </p>  <p>The getter starts off by instantiating a generic instance of LocationInterceptionArgs that will be passed to our aspect’s OnGetValue method. Next it sets the Location property to the LocationInfo held in &lt;&gt;z_Aspects.l7. We saw this in the MethodInterceptionAspect except it was a MethodInfo type instead of LocationInfo. &lt;&gt;z_Aspects.l7 is specifically for the ContactManager.contactRepository field. TypeBinding is then set to the singleton instance of the binding PostSharp has created for contactRepository, ContactManager.&lt;contactRepository&gt;c_Binding. </p>  <p>The TypeBinding is necessary because the LocationInterceptionArgs contain the ProceedSetValue, ProceedGetValue, GetCurrentValue and SetNewValue methods which use the binding to access the field. We use these methods to manipulate the field/property from our aspect.</p>  <p><a href="/assets/images/blog/2011-07-06-day_8_interception_aspects_e28093_part_2/image_9.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/images/blog/2011-07-06-day_8_interception_aspects_e28093_part_2/image_thumb_9.png" width="628" height="425"></a></p>  <p>Finally, our aspect’s OnGetValue method is called passing in the LocationInterceptionArgs and then the value to returned using the LocationInterceptionArgs.TypedValue. TypedValue will always be of the generic type used to instantiate LocationInterceptionArgs. </p>  <h3>Chaining</h3>  <p>When it comes to interception aspects, we have to remember how they work because when applying multiple interception aspects to the same target, a chain is created. Each interception aspect is a node on the invocation chain which means you may or may not be invoking the actual target when proceeding. If we were to apply both a location interception aspect and a method interception aspect to a single target, the chain would become</p>  <p><a href="/assets/images/blog/2011-07-06-day_8_interception_aspects_e28093_part_2/image_10.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/images/blog/2011-07-06-day_8_interception_aspects_e28093_part_2/image_thumb_10.png" width="627" height="517"></a></p>  <p>Each aspect intercepts the preceding aspect. The original call ends up invoking the last applied aspect. It’s important to understand this when applying aspects that change the invocation as many things can be affected such as performance and behavior. </p>  <p>Note that the ordering of the MethodInterceptionAspect and the LocationInterceptionAspect may be inversed. We’ll see another day how to specify the order of application of several aspects when they are applied to the same element of code.</p>  <h3>Conclusion</h3> It may seem overwhelming at first, but once you understand how PostSharp produces its results it’s easy to grasp what’s going on when troubleshooting. Thankfully PostSharp is a mature framework and there are little, if any, side effects.   <p>&#160;</p>  <div style="padding-bottom: 10px; padding-left: 0px; padding-right: 0px; padding-top: 10px"><a href="/assets/images/blog/2011-07-06-day_8_interception_aspects_e28093_part_2/self573_thumb[1]_1.jpg"><img style="background-image: none; border-right-width: 0px; margin: 0px 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; float: left; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="self573_thumb[1]" border="0" alt="self573_thumb[1]" align="left" src="/assets/images/blog/2011-07-06-day_8_interception_aspects_e28093_part_2/self573_thumb[1]_thumb_1.jpg" width="66" height="66"></a>Dustin Davis is an enterprise solutions developer and regularly speaks at user groups and code camps. He can be followed on Twitter <a href="http://twitter.com/#!/PrgrmrsUnlmtd">@PrgrmrsUnlmtd</a> or his blog <a href="http://www.programmers-unlimited.com">Programmers-Unlimited.com</a> </div>
